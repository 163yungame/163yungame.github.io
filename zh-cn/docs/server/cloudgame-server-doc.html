<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="cloudgame-server-doc" />
	<meta name="description" content="cloudgame-server-doc" />
	<!-- 网页标签标题 -->
	<title>cloudgame-server-doc</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot="" data-reactid="1" data-react-checksum="-1047570648"><header class="header-container header-container-normal" data-reactid="2"><div class="header-body" data-reactid="3"><a href="/zh-cn/index.html" data-reactid="4"><img class="logo" src="http://nosdn-yx.127.net/yxgame/6dfac650089849dc8281ffef5e164127.png" data-reactid="5"/></a><div class="header-menu" data-reactid="6"><img class="header-menu-toggle" src="/img/system/menu_gray.png" data-reactid="7"/><ul data-reactid="8"><li class="menu-item menu-item-normal" data-reactid="9"><a href="/zh-cn/index.html" target="_self" data-reactid="10">首页</a></li><li class="menu-item menu-item-normal" data-reactid="11"><a href="/zh-cn/docs/resources/resources.html" target="_self" data-reactid="12">接入指引</a></li><li class="menu-item menu-item-normal" data-reactid="13"><a href="/zh-cn/docs/client/gamesdk.html" target="_self" data-reactid="14">客户端</a></li><li class="menu-item menu-item-normal" data-reactid="15"><a href="/zh-cn/docs/server/cloudgame-server-doc.html" target="_self" data-reactid="16">服务器</a></li></ul></div></div></header><div class="bar" data-reactid="17"><div class="bar-body" data-reactid="18"><img src="/img/system/docs.png" class="front-img" data-reactid="19"/><span data-reactid="20">接入文档</span><img src="/img/system/docs.png" class="back-img" data-reactid="21"/></div></div><section class="content-section" data-reactid="22"><div class="sidemenu" data-reactid="23"><div class="sidemenu-toggle" data-reactid="24"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png" data-reactid="25"/></div><ul data-reactid="26"><li class="menu-item menu-item-level-1" data-reactid="27"><span data-reactid="28">接入文档</span><ul data-reactid="29"><li style="height:36px;overflow:hidden;" class="menu-item menu-item-level-2" data-reactid="30"><a href="/zh-cn/docs/resources/resources.html" target="_self" data-reactid="31">接入指引</a></li><li style="height:36px;overflow:hidden;" class="menu-item menu-item-level-2" data-reactid="32"><span data-reactid="33"><!-- react-text: 34 -->客户端<!-- /react-text --><img style="transform:rotate(-90deg);" class="menu-toggle" src="/img/system/arrow_down.png" data-reactid="35"/></span><ul data-reactid="36"><li class="menu-item menu-item-level-3" data-reactid="37"><a href="/zh-cn/docs/client/gamesdk.html" target="_self" data-reactid="38">接入指南</a></li><li class="menu-item menu-item-level-3" data-reactid="39"><a href="/zh-cn/docs/client/faq.html" target="_self" data-reactid="40">Q&amp;A</a></li></ul></li><li style="height:36px;overflow:hidden;" class="menu-item menu-item-level-2" data-reactid="41"><span data-reactid="42"><!-- react-text: 43 -->服务器<!-- /react-text --><img style="transform:rotate(-90deg);" class="menu-toggle" src="/img/system/arrow_down.png" data-reactid="44"/></span><ul data-reactid="45"><li class="menu-item menu-item-level-3" data-reactid="46"><a href="/zh-cn/docs/server/cloudgame-server-doc.html" target="_self" data-reactid="47">接入指南</a></li><li class="menu-item menu-item-level-3" data-reactid="48"><a href="/zh-cn/docs/server/php_sign_demo.html" target="_self" data-reactid="49">php下单签名示例</a></li><li class="menu-item menu-item-level-3" data-reactid="50"><a href="/zh-cn/docs/server/python_sign_demo.html" target="_self" data-reactid="51">python下单签名示例</a></li><li class="menu-item menu-item-level-3" data-reactid="52"><a href="/zh-cn/docs/server/faq.html" target="_self" data-reactid="53">Q&amp;A</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body" data-reactid="54"><h1>云游戏服务端接入文档</h1>
<h2>0.版本变更记录</h2>
<table>
<thead>
<tr>
<th>修订内容描述</th>
<th>修订日期</th>
<th>版本号</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建文档</td>
<td>20140130</td>
<td>1.0</td>
</tr>
<tr>
<td>去掉goodscount参数</td>
<td>20140221</td>
<td>1.1</td>
</tr>
<tr>
<td>重构文档</td>
<td>20140226</td>
<td>1.2</td>
</tr>
<tr>
<td>增加手机话费支付更新商品信息说明。</td>
<td>20140311</td>
<td>1.3</td>
</tr>
<tr>
<td>增加Android客户端集成支付SDK</td>
<td>20140312</td>
<td>1.4</td>
</tr>
<tr>
<td>修改Android客户端集成支付SDK说明</td>
<td>20150527</td>
<td>1.5</td>
</tr>
<tr>
<td>增加文字描述</td>
<td>20150909</td>
<td>1.6</td>
</tr>
<tr>
<td>更新银联SDK</td>
<td>20150916</td>
<td>1.7</td>
</tr>
<tr>
<td>新增网易支付SDK</td>
<td>20160504</td>
<td>1.8</td>
</tr>
<tr>
<td>新增微信支付SDK</td>
<td>20160605</td>
<td>1.9</td>
</tr>
<tr>
<td>更新网易支付SDK</td>
<td>20160711</td>
<td>2.0</td>
</tr>
<tr>
<td>添加透传机制</td>
<td>20161226</td>
<td>2.1</td>
</tr>
<tr>
<td>增加获取用户信息接口</td>
<td>20170915</td>
<td>2.2</td>
</tr>
<tr>
<td>增加支付流程角色说明</td>
<td>20170917</td>
<td>2.3</td>
</tr>
<tr>
<td>梳理异常和签名错误FAQ</td>
<td>20171010</td>
<td>2.4</td>
</tr>
<tr>
<td>文档markdown，删除无用信息</td>
<td>20180813</td>
<td>2.5</td>
</tr>
</tbody>
</table>
<h2>1.支付流程</h2>
<h3>1.1 支付中各角色交互说明</h3>
<p><img src="https://nosdn-yx.127.net/yxgame/977e2c0b38784cb181b369d99be3641f.jpg" alt="支付中各角色交互说明"></p>
<p><strong>参与支付流程交互的角色有：</strong></p>
<ul>
<li><strong>游戏APP（以下也称第三方App）</strong>：需要集成网易云游戏SDK
<ul>
<li>调用游戏Server接口生成订单</li>
<li>调用SDK接口进行支付</li>
</ul>
</li>
<li><strong>游戏Server（以下也称第三方服务器）</strong>：
<ul>
<li>负责生成订单，并将订单信息持久化到第三方服务器，生成订单过程中需要与网易云游戏Server交互，生成网易云游戏Server的订单信息（Trade信息），并一起返回给游戏App</li>
<li>负责接收网易有游戏Server支付回调，处理发货逻辑</li>
</ul>
</li>
<li><strong>网易云游戏Server（以下也称PayServer）</strong>
<ul>
<li>根据游戏Server订单，生成订单信息（Trade信息），返回给游戏Server</li>
<li>接收支付工具Server（如支付宝、微信等）的回调，并回调游戏Server接口</li>
</ul>
</li>
</ul>
<p>从上面的描述中，第三方游戏接入网易云游戏仅需要关心以下部分流程:</p>
<ol>
<li>游戏App向游戏Server发起生成订单</li>
<li>游戏Server向网易云游戏Server发起生成订单</li>
<li>游戏App调用网易云游戏SDK接口发起支付</li>
<li>游戏Server接收网易云游戏Server异步支付成功回调</li>
</ol>
<h3>1.2 完整交易流程</h3>
<p><img src="https://nosdn-yx.127.net/yxgame/90ba0613bcdd40efb9d517c7317f111b.jpg" alt=""></p>
<p><strong>流程说明</strong></p>
<p>由流程图可知</p>
<ol>
<li><code>第三方APP</code>负责调用<code>第三方Server``生成订单1.1</code>，并处理返回值、封装成trade参数调用<code>sdk.pay(trade)2.1</code>接口。用户支付完成后，<code>SDK</code>回调<code>接口返回支付结果2.8</code>给<code>第三方APP</code></li>
<li><code>第三方Server</code>负责生成订单，并将订单信息持久化到数据库。</li>
<li><code>第三方Server</code>负责处理支付通知，并对支付成功的订单进行发货、更改数据库状态，在支付成功后，<code>PayServer</code>通过<code>异步发送支付通知4.1</code>通知<code>第三方Server</code>发货，<code>第三方Server</code>自行进行发货。</li>
</ol>
<p><strong><code>流程注意点</code></strong></p>
<ol>
<li>调用支付接口时都:star:<code>必须</code>:star:传递用户的access_token，用于提取用户名、验证。</li>
<li>:star:<code>任一步</code>:star:都可能中断，要保证最终数据的一致性、正确。比如悬挂订单最终要超时。</li>
<li>:star:<code>任一步</code>:star:都要签名，防篡改、欺骗、重放。</li>
<li>:star:<code>任一步</code>:star:都有可能多次重复调用，被调用者负责去重。</li>
</ol>
<h2>2.服务端接口</h2>
<p>服务器端接口包括<code>第三方Server</code>、<code>PayServer</code>提供给对方和Android客户端的接口。主要包括订单生成、支付通知两类接口。考虑到安全性，除了用户输入、UI交互接口需要在Android端完成，其他跟支付有关的接口必须在服务器端进行调用。签名由服务器端进行，公钥不要暴露在Android端。</p>
<h3>2.1 接口约定</h3>
<h4>2.1.1 订单信息持久化</h4>
<p><code>第三方Server</code>需要对订单信息包括订单id、支付状态、各类时间戳等信息、接口参数使用数据库进行持久化用来对账。</p>
<h4>2.1.2 支付通知并发</h4>
<p>支付完成后<code>Payserver</code>调用<code>第三方Server</code>接口通知发货，相同订单支付通知接口可能被调用多次，需要去重并避免重复发货等问题。如更新数据库时可以使用类似的SQL:</p>
<pre><code class="language-sql"><span class="hljs-keyword">update</span> Trade <span class="hljs-keyword">set</span> PayState=Payed <span class="hljs-keyword">where</span> PayState=UnPay <span class="hljs-keyword">and</span> <span class="hljs-keyword">Id</span>=?;
</code></pre>
<h4>2.1.3 两个公钥，一个私钥:star:<code>很重要</code>:star:</h4>
<p>网易云游戏需要两个公钥一个私钥。请<code>谨记</code>括号里面的名字。</p>
<ol>
<li>游戏方接入方公钥及私钥请联系贵方商务或运营从开发者后台获取。(以下称:star:<code>游戏方公钥</code>:star:或:star:<code>游戏方私钥</code>:star:)
<img src="http://nosdn-yx.127.net/yxgame/0be8e326369a4f64a44b03c193faf243.jpg" alt="游戏方接入方公私钥获取"></li>
<li>平台公钥(以下称:star:<code>平台公钥</code>:star:)</li>
</ol>
<pre><code>30819f300d06092a864886f70d010101050003818d0030818902818100ac1b8d63bcaf49cdd0d1e79c916aba0250421b3ee8eaf134f80843c5033e30a150b9e26e78025fde8e52538d4beb572940966b0c80460d90a26c9119a0d28c4277024dbeb20e31403360aeca70da506a19d89e95512e5347be0eae9b2c49da3150a93e3bc80817fa9a1d8170555e6117c86f84f13afc39944fb6bdfc85e3723b0203010001
</code></pre>
<h4>2.1.4 签名校验及参数值编码</h4>
<p>:star:<code>非常重要</code>:star:绝大部分平台接入失败都卡在签名这一步，请仔细阅读下面各点。</p>
<h5>2.1.4.1 注意点</h5>
<ol>
<li>拼接在请求URL上的参数，需要进行URLEncode, 如<code>String param = URLEncoder.encode(&quot;2014-01-01 12:12:12&quot;, &quot;UTF-8&quot;);</code>, 输出为<code>2014-01-01+12%3A12%3A12</code></li>
<li><code>第三方Server</code>请求<code>PayServer</code>的接口，传递的参数中的<code>sign签名</code>字段的操作
<ul>
<li>将参与签名的参数进行<code>字符串拼接</code> (参与签名计算的参数会在每个接口中进行说明)</li>
<li>:star:<code>需要、需要、需要</code>:star:进行<code>URLEncode</code></li>
<li>使用<code>Android Demo</code>工程的类<code>im.yixin.game.demo.rsa.RSA</code>中的<code>RSA.sign()</code>接口和:star:<code>游戏方私钥</code>:star:以及上述拼接字符串生成签名串</li>
</ul>
</li>
<li><code>第三方Server</code>请求<code>PayServer</code>的接口后校验返回的参数中的<code>sign签名</code>字段的操作
<ul>
<li>将参与签名的参数进行<code>字符串拼接</code> (参与签名计算的参数会在每个接口中进行说明)</li>
<li>:star:<code>不需要、不需要、不需要</code>:star:进行<code>URLEncode</code></li>
<li>使用<code>Android Demo</code>工程的类<code>im.yixin.game.demo.rsa.RSA</code>中的<code>RSA.verify()</code>接口和:star:<code>平台公钥</code>:star:以及上述拼接字符串验证<code>sign</code>参数是否正确，正确再执行业务逻辑</li>
</ul>
</li>
<li><code>第三方Server</code>接收<code>PayServer</code>的支付通知回调接口的<code>sign签名</code>字段操作
<ul>
<li>将参与签名的参数进行<code>字符串拼接</code> (参与签名计算的参数会在每个接口中进行说明)</li>
<li>:star:<code>需要、需要、需要</code>:star:进行<code>URLEncode</code></li>
<li>使用<code>Android Demo</code>工程的类<code>im.yixin.game.demo.rsa.RSA</code>中的<code>RSA.verify()</code>接口和:star:<code>平台公钥</code>:star:以及上述拼接字符串验证<code>sign</code>参数是否正确，正确再执行业务逻辑</li>
</ul>
</li>
</ol>
<h5>2.1.4.2 生成和验证签名Java Demo</h5>
<p><code>php</code>、<code>python</code>Demo请参考Android SDK文档包中的<code>doc/服务端</code></p>
<ul>
<li>生成签名流程</li>
</ul>
<pre><code class="language-java"><span class="hljs-comment">// 生成签名 需要哪些参数请仔细看每个接口的说明</span>
StringBuilder signSrcSb = <span class="hljs-keyword">new</span> StringBuilder();
signSrcSb.append(v);
signSrcSb.append(thirdpart_orderid);
signSrcSb.append(thirdpart_ordertime);
signSrcSb.append(tradeName);
signSrcSb.append(access_token);
<span class="hljs-comment">// 如果goodscount为1或不传则不需要添加此项</span>
<span class="hljs-keyword">if</span> (goodscount &gt; <span class="hljs-number">1L</span>) {
    signSrcSb.append(goodscount);
}
<span class="hljs-comment">// 需不需要Encode，参考每个接口的说明，每个都不一样，请仔细看，不需要的话直接用</span>
<span class="hljs-comment">// String signSrc = signSrcSb.toString(); 即可</span>
String signSrc = URLEncoder.encode(signSrcSb.toString(), <span class="hljs-string">"UTF-8"</span>);
<span class="hljs-comment">// 注意看接口说明，一般情况生成签名用privateKey，验证签名用publicKey</span>
PrivateKey privateKey = RSA.getPrivateKey(<span class="hljs-string">"游戏方私钥"</span>);
String sign = RSA.sign(privateKey, signSrc);
</code></pre>
<ul>
<li>验证签名流程</li>
</ul>
<pre><code class="language-java"><span class="hljs-comment">// 验证签名 具体需要拼接哪些参数，请查看后续接口文档</span>
StringBuilder signSrcSb4Ret = <span class="hljs-keyword">new</span> StringBuilder();
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"v"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"thirdpart_orderid"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"thirdpart_ordertime"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"result"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"trade_serialid"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"goodsprice"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"goodsamount"</span>));
signSrcSb4Ret.append(retMap.get(<span class="hljs-string">"pay_url"</span>));
<span class="hljs-keyword">if</span> (goodscount &gt; <span class="hljs-number">1L</span>) {
    signSrcSb4Ret.append(goodscount);
}
<span class="hljs-comment">//</span>
PublicKey publicKey = RSA.getPublicKey(<span class="hljs-string">"平台公钥"</span>)
<span class="hljs-comment">// signSrcSb4Ret.toString() 查看接口文档决定此处是否需要URLEncode</span>
<span class="hljs-comment">// 验证失败则抛出异常</span>
RSA.verify(publicKey, sign, signSrcSb4Ret.toString());
</code></pre>
<h3>2.2 返回异常说明</h3>
<table>
<thead>
<tr>
<th>异常码</th>
<th>说明</th>
<th>用户页面提示文案</th>
</tr>
</thead>
<tbody>
<tr>
<td>-1</td>
<td>服务器内部异常。未知异常，或无需详细说明的一般性异常。</td>
<td>支付请求失败，请重试</td>
</tr>
<tr>
<td>-2</td>
<td>登陆账号异常</td>
<td>账号登录失败，请重试</td>
</tr>
<tr>
<td>-3</td>
<td>生成签名失败</td>
<td>生成签名失败，请重试</td>
</tr>
<tr>
<td>-4</td>
<td>验证签名失败</td>
<td>验证签名失败，请重试</td>
</tr>
<tr>
<td>-5</td>
<td>商品不存在</td>
<td>商品不存在，请重试</td>
</tr>
<tr>
<td>-6</td>
<td>订单不存在</td>
<td>订单不存在，请重试</td>
</tr>
<tr>
<td>-7</td>
<td>支付方式错误</td>
<td>支付方式错误，请重试</td>
</tr>
<tr>
<td>-8</td>
<td>参数非法</td>
<td>参数非法</td>
</tr>
<tr>
<td>-9</td>
<td>支付超时</td>
<td>支付超时，请重新支付</td>
</tr>
<tr>
<td>-10</td>
<td>更新支付类型失败(已经有支付类型或者已经支付)</td>
<td>更新支付类型失败</td>
</tr>
<tr>
<td>-31</td>
<td>第三方订单号重复</td>
<td>订单重复</td>
</tr>
<tr>
<td>-51</td>
<td>支付工具通知的支付状态非法</td>
<td>无效订单</td>
</tr>
<tr>
<td>-101</td>
<td>服务器内部错误，数据库异常</td>
<td>支付数据请求失败，请重试</td>
</tr>
<tr>
<td>-1001</td>
<td>渠道游戏的状态为停用，无法下单</td>
<td>无效订单</td>
</tr>
</tbody>
</table>
<h3>2.3 生成订单接口</h3>
<p>本接口为流程图中的<code>生成支付订单1.2</code>接口，<code>第三方Server</code>在生成订单时调用<code>PayServer</code>的此接口。</p>
<h4>2.3.1 接口定义</h4>
<ul>
<li>URL: <code>https://open.game.163.com/pay/games/{gameid}/add/trades</code></li>
<li>提供方: <code>PayServer</code></li>
<li>调用方: <code>第三方Server</code></li>
<li>请求方式: <code>POST</code></li>
<li>路径参数: <code>gameid</code>接入方的游戏id，有游戏中心分配，在开发者后台创建游戏时自动生成</li>
<li>订单唯一性保证: 相同的<code>thirdpart_orderid</code>、<code>thirdpart_ordertime</code>为<code>第三方Server</code>唯一订单号，不能重复调用此接口生成订单</li>
</ul>
<h4>2.3.2 请求参数</h4>
<p>:star:<code>拼接在URL中</code>:star:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称(FulfillWithEngCharacter)</th>
<th>参数说明</th>
<th>类型(字符长度)</th>
<th>必传</th>
</tr>
</thead>
<tbody>
<tr>
<td>v</td>
<td>接口版本号</td>
<td>接口版本号。将来版本兼容使用。该参数请从客户端SDK中<code>YXPayConstants.YX_PAY_SDK_VERSION</code>动态获取后传递到服务端, 不要写死在服务端</td>
<td>String</td>
<td>是</td>
</tr>
<tr>
<td>thirdpart_orderid</td>
<td>第三方唯一订单id</td>
<td>同一订单	String(64)</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>thirdpart_ordertime</td>
<td>第三方订单下单时间</td>
<td>格式(yyyy-MM-dd HH:mm:ss)</td>
<td>String(64)</td>
<td>是</td>
</tr>
<tr>
<td>tradeName</td>
<td>商品名称</td>
<td>小写英文字母或数字或中文</td>
<td>String(240)</td>
<td>是</td>
</tr>
<tr>
<td>price</td>
<td>商品单价</td>
<td>金额，单位元，精确到分，如0.01元</td>
<td>String</td>
<td>是</td>
</tr>
<tr>
<td>access_token</td>
<td>oauth token</td>
<td>登陆时返回，用于账号验证。</td>
<td>String</td>
<td>是</td>
</tr>
<tr>
<td>goodscount</td>
<td>购买数量</td>
<td>为兼容老版，不传默认为1</td>
<td>Int</td>
<td>否</td>
</tr>
<tr>
<td>sign</td>
<td>签名</td>
<td>请先阅读<a href="https://github.com/dingbupt/cloudgame-doc/wiki/cloudgame-server-doc#214-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%8F%8A%E5%8F%82%E6%95%B0%E5%80%BC%E7%BC%96%E7%A0%81">2.1.4 签名校验及参数值编码</a>,参与签名的参数:star:严格:star:依照以下顺序，中间的<code>+</code>表示前后字符串直接拼接，不要把<code>+</code>加到字符串中，拼接后:star:<code>需要URLEncode</code>:star:, <code>v+thirdpart_orderid+thirdpart_ordertime+tradeName+access_token+goodscount</code>,<code>goodscount</code>不传或者为1时:star:<code>不参与</code>:star:签名字符串拼接,使用:star:<code>游戏方私钥</code>:star:进行签名生成计算</td>
<td>String</td>
<td>是</td>
</tr>
</tbody>
</table>
<h4>2.3.3 返回值</h4>
<ul>
<li>返回值格式: <code>JSON</code></li>
<li>异常返回格式: 返回码见上面</li>
</ul>
<pre><code class="language-json">{
	<span class="hljs-attr">"result"</span>:<span class="hljs-number">-1</span>,
	<span class="hljs-attr">"errorMsg"</span>:<span class="hljs-string">"服务器异常"</span>
}
</code></pre>
<ul>
<li>正常返回时，无上述两个字段</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称(FulfillWithEngCharacter)</th>
<th>参数说明</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>v</td>
<td>接口版本号</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>thirdpart_orderid</td>
<td>第三方唯一订单id</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>thirdpart_ordertime</td>
<td>第三方订单下单时间</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>result</td>
<td>返回结果</td>
<td>正常0、异常时返回异常号</td>
<td>int</td>
</tr>
<tr>
<td>trade_serialid</td>
<td>支付平台订单序列号</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>goodsprice</td>
<td>商品单价</td>
<td>单位元，精确到分，如0.01元</td>
<td>String</td>
</tr>
<tr>
<td>goodsamount</td>
<td>支付总金额</td>
<td>单位元，精确到分，如0.01元</td>
<td>String</td>
</tr>
<tr>
<td>pay_url</td>
<td>支付工具页面跳转url</td>
<td>包含支付页面需要的参数。第三方Server需要原样返回给客户端。</td>
<td>String</td>
</tr>
<tr>
<td>sign</td>
<td>签名</td>
<td>请先阅读<a href="https://github.com/dingbupt/cloudgame-doc/wiki/cloudgame-server-doc#214-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%8F%8A%E5%8F%82%E6%95%B0%E5%80%BC%E7%BC%96%E7%A0%81">2.1.4 签名校验及参数值编码</a>,参与签名的参数:star:严格:star:依照以下顺序，中间的<code>+</code>表示前后字符串直接拼接，不要把<code>+</code>加到字符串中，拼接后:star:<code>不需要URLEncode</code>:star:，<code>v+thirdpart_orderid+thirdpart_ordertime+result+trade_serialid+goodsprice+goodsamount+pay_url+goodscount</code>, <code>goodscount</code>为请求时的参数，不传或者为1时:star:<code>不参与</code>:star:签名字符串拼接，使用:star:<code>平台公钥</code>:star:进行签名验证计算</td>
<td>String</td>
</tr>
</tbody>
</table>
<h3>2.4 PayServer异步支付通知</h3>
<p>本接口为流程图中的<code>异步发送支付通知 4.1</code>接口。Android页面通知可能因为网络故障导致通知失败，需要<code>PayServer</code>多次异步通知来保证通知到<code>第三方Server</code>。</p>
<ol>
<li><code>第三方Server</code>可以将此接口和Android页面通知接口在同一个接口中合并处理，此接口增加了<code>notifyid</code>、<code>notifytime</code>两个参数，并且<code>from</code>值不一样。</li>
<li><code>第三方Server</code>需要去重，可能会重复通知，避免多次发货</li>
<li>当<code>第三方Server</code>响应<code>success</code>字符串时，<code>PayServer</code>停止异步通知，否则按如下时间间隔不断通知直到收到<code>success</code>：40秒、2分钟、5分钟、10分钟、30分钟、1小时、2小时、6小时、15小时，超过以上时间后，即使没接收到<code>success</code>也不再通知。</li>
</ol>
<h4>2.4.1 接口定义</h4>
<ul>
<li>URL: <code>第三方Server</code>定义并填写到开发者后台的对应游戏配置中</li>
<li>提供方: <code>第三方Server</code></li>
<li>调用方: <code>PayServer</code></li>
<li>请求方式: <code>POST</code></li>
</ul>
<h4>2.4.2 请求参数</h4>
<p>:star:<code>拼接在URL中</code>:star:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称(FulfillWithEngCharacter)</th>
<th>参数说明</th>
<th>类型(字符长度)</th>
</tr>
</thead>
<tbody>
<tr>
<td>v</td>
<td>接口版本号</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>thirdpart_orderid</td>
<td>第三方唯一订单id</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>thirdpart_ordertime</td>
<td>第三方订单下单时间</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>tradeName</td>
<td>商品名称</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>result</td>
<td>返回结果</td>
<td>正常0、异常时返回异常号。返回异常时其他字段可能不返回。</td>
<td>int</td>
</tr>
<tr>
<td>trade_serialid</td>
<td>支付平台订单序列号</td>
<td></td>
<td>String</td>
</tr>
<tr>
<td>goodsprice</td>
<td>商品单价</td>
<td>单位元，精确到分，如0.01元</td>
<td>String</td>
</tr>
<tr>
<td>goodsamount</td>
<td>支付金额</td>
<td>单位元，精确到分，如0.01元</td>
<td>String</td>
</tr>
<tr>
<td>paystatus</td>
<td>支付结果</td>
<td>支付状态：0未支付1已支付成功2关闭。result返回0时才有此字段。</td>
<td>int</td>
</tr>
<tr>
<td>paytime</td>
<td>付款时间</td>
<td></td>
<td>long</td>
</tr>
<tr>
<td>paytooltype</td>
<td>支付工具类型</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td>notifyid</td>
<td>通知内部id</td>
<td>用于校验</td>
<td>long</td>
</tr>
<tr>
<td>notifytime</td>
<td>通知时间戳</td>
<td></td>
<td>long</td>
</tr>
<tr>
<td>from</td>
<td>来源参数</td>
<td>值固定为<code>backend</code></td>
<td>String</td>
</tr>
<tr>
<td>sign</td>
<td>签名</td>
<td>请先阅读<a href="https://github.com/dingbupt/cloudgame-doc/wiki/cloudgame-server-doc#214-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%8F%8A%E5%8F%82%E6%95%B0%E5%80%BC%E7%BC%96%E7%A0%81">2.1.4 签名校验及参数值编码</a>,参与签名的参数:star:严格:star:依照以下顺序，中间的<code>+</code>表示前后字符串直接拼接，不要把<code>+</code>加到字符串中，拼接后:star:<code>需要URLEncode</code>:star:, <code>v+thirdpart_orderid+thirdpart_ordertime+tradeName+result+trade_serialid+goodsprice+goodsamount+paystatus+paytime+paytooltype+notifyid+notifytime+from</code>,使用:star:<code>平台公钥</code>:star:进行签名验证计算</td>
<td>String</td>
</tr>
</tbody>
</table>
<h4>2.4.3 返回值</h4>
<p>成功处理则返回<code>success</code>这7个字符，失败返回<code>fail</code>。</p>
<h3>2.5 获取用户信息</h3>
<p>获取用户信息，校验access_token有效性, 本接口无签名校验</p>
<h4>2.5.1 接口定义</h4>
<ul>
<li>URL: <code>https://open.game.163.com/api/user/info</code></li>
<li>提供方: <code>PayServer</code></li>
<li>调用方: <code>第三方Server</code></li>
<li>请求方式: <code>GET</code></li>
</ul>
<h4>2.5.2 请求参数</h4>
<p>拼接在URL中</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称(FulfillWithEngCharacter)</th>
<th>参数说明</th>
<th>类型(字符长度)</th>
</tr>
</thead>
<tbody>
<tr>
<td>access_token</td>
<td>token值</td>
<td>从客户端获取的token值</td>
<td>String</td>
</tr>
</tbody>
</table>
<h4>2.5.3 返回值</h4>
<ul>
<li>返回值格式: <code>JSON</code></li>
<li>异常返回格式: <code>非1</code>的<code>code</code>值都是异常返回，<code>code</code>一定有，<code>errorMsg</code>可能没有</li>
</ul>
<pre><code class="language-json">{
	<span class="hljs-attr">"code"</span>: <span class="hljs-number">400</span>,
	<span class="hljs-attr">"errorMsg"</span>: <span class="hljs-string">"access_token is illegal,oauthUserApp is empty"</span>
}
</code></pre>
<ul>
<li>正常返回时，<code>code</code>值为<code>1</code></li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数名称(FulfillWithEngCharacter)</th>
<th>参数说明</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>code</td>
<td>响应码</td>
<td>响应码，1为正确，其他都是异常</td>
<td>int</td>
</tr>
<tr>
<td>userinfo</td>
<td>用户信息</td>
<td>code为1时有</td>
<td>Object</td>
</tr>
<tr>
<td>accountId</td>
<td>支付方用户账号</td>
<td>包含在userinfo内，支付方用户账号</td>
<td>String</td>
</tr>
<tr>
<td>nick</td>
<td>用户昵称</td>
<td>包含在userinfo内，用户昵称</td>
<td>String</td>
</tr>
<tr>
<td>icon</td>
<td>用户头像</td>
<td>包含在userinfo内，用户头像</td>
<td>String</td>
</tr>
<tr>
<td>registerUser</td>
<td>为用户是否在支付方已经实名认证</td>
<td>包含在userinfo内，是否在支付方已经实名认证</td>
<td>boolean</td>
</tr>
</tbody>
</table>
<p>示例</p>
<pre><code class="language-json">{
	<span class="hljs-attr">"userinfo"</span>: {
		<span class="hljs-attr">"accountId"</span>: <span class="hljs-string">"7a950a752ca8bef6"</span>,
		<span class="hljs-attr">"nick"</span>: <span class="hljs-string">"yazhitest"</span>,
		<span class="hljs-attr">"icon"</span>: <span class="hljs-string">"http://nos.netease.com/yixinpublic/pr_tp8qsfuk8xlsyhj98qooeq==_1422263772_13102"</span>,
		<span class="hljs-attr">"registerUser"</span>: <span class="hljs-literal">true</span>
	},
	<span class="hljs-attr">"code"</span>: <span class="hljs-number">1</span>
}
</code></pre>
</div></section></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>