{
  "filename": "php_sign_demo.md",
  "__html": "<h1>php 签名示例</h1>\n<pre><code class=\"language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n\n\t$gameid = <span class=\"hljs-string\">\"\"</span>;\n\t<span class=\"hljs-comment\">//网易云后台私钥</span>\n\t$privateKey = <span class=\"hljs-string\">\"\"</span>;\n\n\t<span class=\"hljs-comment\">//服务器接入文档上的支付平台公钥</span>\n\t$publicKey = <span class=\"hljs-string\">\"\"</span>;\n\n\t<span class=\"hljs-comment\">//订单数据</span>\n\t$order = <span class=\"hljs-keyword\">Array</span>(\n\t    <span class=\"hljs-string\">'v'</span> =&gt; <span class=\"hljs-number\">13</span>,\n\t    <span class=\"hljs-string\">'thirdpart_orderid'</span> =&gt; <span class=\"hljs-number\">123456</span>,\n\t    <span class=\"hljs-string\">'thirdpart_ordertime'</span> =&gt; <span class=\"hljs-string\">'2018-05-16 14:31:53'</span>,\n\t    <span class=\"hljs-string\">'tradeName'</span> =&gt; <span class=\"hljs-string\">'ProductName1'</span>,\n\t    <span class=\"hljs-string\">'price'</span> =&gt; <span class=\"hljs-number\">998.00</span>,\n\t    <span class=\"hljs-string\">'access_token'</span> =&gt; <span class=\"hljs-string\">'f178d-fe93-4f9a-9383-19648dd'</span>,\n\t);\n\t$order[<span class=\"hljs-string\">'sign'</span>] = getOrderSign($order, $privatekey);\n\n\t$url = <span class=\"hljs-string\">\"https://open.game.163.com/pay/games/{$gameid}/add/trades\"</span>;\n\t$result = httpCurl($url ,$order);   <span class=\"hljs-comment\">// 生成订单接口</span>\n\t$_rst = getVerifySign($result, $publicKey); <span class=\"hljs-comment\">//验证返回签名数据</span>\n\t<span class=\"hljs-keyword\">if</span>($_rst) {\n\t\t<span class=\"hljs-comment\">//success 返回 trade_serialid 和 pay_url</span>\n\t\t<span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">'success'</span>);\n\t}\n\n\n\n\t<span class=\"hljs-comment\">//2.3.\tPayServer异步通知   网易服务器通知支付结果</span>\n\t$_signCheck = getVerifySign($data, $publicKey,<span class=\"hljs-keyword\">true</span>);\n\t<span class=\"hljs-keyword\">if</span>($_signCheck) {\n\t\t<span class=\"hljs-comment\">//success cp完成支付成功之后逻辑</span>\n\t\t<span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">'success'</span>);\n\t}\n\n\t<span class=\"hljs-comment\">// 生产签名</span>\n\t<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getOrderSign</span><span class=\"hljs-params\">($data,$Key)</span>\n    </span>{\n        $sourcestr = <span class=\"hljs-string\">''</span>;\n        <span class=\"hljs-keyword\">foreach</span> ($data <span class=\"hljs-keyword\">as</span> $key =&gt; $value) {\n            <span class=\"hljs-keyword\">if</span>($key == <span class=\"hljs-string\">'price'</span>) <span class=\"hljs-keyword\">continue</span>;\n            $sourcestr .= urlencode($value);\n        }\n\n        $devKey = base64_encode(hex2bin($Key));\n        $begin_private_key = <span class=\"hljs-string\">\"-----BEGIN RSA PRIVATE KEY-----\\n\"</span>;\n        $end_private_key = <span class=\"hljs-string\">\"-----END RSA PRIVATE KEY-----\\n\"</span>;\n\n        $str = chunk_split($devKey, <span class=\"hljs-number\">64</span>, <span class=\"hljs-string\">\"\\n\"</span>);\n\n        $privateKey = $begin_private_key.$str.$end_private_key;\n\n        $pkeyid = openssl_get_privatekey($privateKey);\n        openssl_sign($sourcestr, $signature, $pkeyid,OPENSSL_ALGO_SHA1);\n        openssl_free_key($pkeyid);\n        <span class=\"hljs-keyword\">return</span> bin2hex($signature);\n    }\n\n    <span class=\"hljs-comment\">// 校验网易云签名</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getVerifySign</span><span class=\"hljs-params\">($data, $pubKey,$isEncode=false)</span>\n    </span>{\n        $content = <span class=\"hljs-string\">''</span>;\n        <span class=\"hljs-keyword\">foreach</span> ($data <span class=\"hljs-keyword\">as</span> $key =&gt; $value) {\n\n            <span class=\"hljs-keyword\">if</span>(($key == <span class=\"hljs-string\">'goodscount'</span> &amp;&amp; $value ==<span class=\"hljs-number\">1</span>) || $key == <span class=\"hljs-string\">'sign'</span>) <span class=\"hljs-keyword\">continue</span>;\n            <span class=\"hljs-keyword\">if</span>($isEncode)\n            \t$content .= urlencode($value);\n            <span class=\"hljs-keyword\">else</span>\n            \t$content .= $value;\n        }\n\n        $devKey = base64_encode(hex2bin($pubKey));\n        $begin_public_key = <span class=\"hljs-string\">\"-----BEGIN PUBLIC KEY-----\\n\"</span>;\n        $end_public_key = <span class=\"hljs-string\">\"-----END PUBLIC KEY-----\\n\"</span>;\n\n        $str = chunk_split($devKey, <span class=\"hljs-number\">64</span>, <span class=\"hljs-string\">\"\\n\"</span>);\n\n        $publickey = $begin_public_key.$str.$end_public_key;\n\n        $openssl_public_key = openssl_get_publickey($publickey);\n        $ok = openssl_verify($content,hex2bin($data[<span class=\"hljs-string\">'sign'</span>]), $openssl_public_key, OPENSSL_ALGO_SHA1);\n        openssl_free_key($openssl_public_key);\n        <span class=\"hljs-keyword\">return</span> $ok;\n    }\n\n    <span class=\"hljs-comment\">//发送https请求</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">httpCurl</span><span class=\"hljs-params\">($url, $postData = array<span class=\"hljs-params\">()</span>, $isSsl = <span class=\"hljs-number\">0</span>,$timeout=<span class=\"hljs-number\">5</span>)</span>\n    </span>{\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class=\"hljs-number\">1</span>);\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);\n        <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">empty</span>($postData)) {\n            <span class=\"hljs-keyword\">if</span> (is_array($postData)) {\n                $data = urldecode(http_build_query($postData));\n            } <span class=\"hljs-keyword\">else</span> {\n                $data = $postData;\n            }\n            curl_setopt($ch, CURLOPT_POST, <span class=\"hljs-keyword\">true</span>);\n            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);\n            <span class=\"hljs-keyword\">if</span> (strpos($url, <span class=\"hljs-string\">\"?\"</span>)) {\n                $url .= <span class=\"hljs-string\">\"&amp;\"</span> . $data;\n            } <span class=\"hljs-keyword\">else</span> {\n                $url .= <span class=\"hljs-string\">\"?\"</span> . $data;\n            }\n        }\n        <span class=\"hljs-keyword\">if</span> ($isSsl &gt; <span class=\"hljs-number\">0</span>) {\n            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class=\"hljs-keyword\">false</span>);\n            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class=\"hljs-keyword\">false</span>);\n        }\n        $time = microtime(<span class=\"hljs-number\">1</span>);\n        $result = curl_exec($ch);\n        $time = microtime(<span class=\"hljs-number\">1</span>)-$time;\n        <span class=\"hljs-keyword\">if</span> (curl_errno($ch)) {\n            <span class=\"hljs-comment\">//错误日志</span>\n        } <span class=\"hljs-keyword\">else</span> {\n            $res = is_array($result) ? var_export($result, <span class=\"hljs-keyword\">true</span>) : $result;\n        }\n        curl_close($ch);\n        <span class=\"hljs-keyword\">return</span> $result;\n    }\n<span class=\"hljs-meta\">?&gt;</span>\n</code></pre>\n",
  "link": "/zh-cn/docs/server/php_sign_demo.html",
  "meta": {}
}